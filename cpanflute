#!/usr/bin/perl

# need this for hostname()
use File::Basename;
use Sys::Hostname;
use Getopt::Long;
use strict;

my $MainDir = '/tmp/cpan';
my $perlver = '1:5.8.1';
my $release = '1';

# set default options, then get options
my %options=();
$options{'email'}=(getpwuid($<))[0] . "\@momonga-linux.org" ;
GetOptions(\%options, "email=s", "n=s", "create") || exit 1;

my $InputFile = $ARGV[0];
my $create = '';

if ($options{'create'}) {
  $create = '-c';
}

my $tarball = basename($InputFile);
$tarball =~ /(\S+)\-(\S+)\.tar\.gz/;
my $clm_name=$1;
my $clm_version=$2;

my $class = dirname($InputFile);
$class =~ s/^\.\/[0-9][0-9]_//;
if ($class ne '.') {
  $class = "($class)";
} else {
  $class = "";
}

# Change ::'s to -'s
$clm_name =~ s/::/-/g;
my $clm_base = $clm_name;
$clm_base =~ s/-.*//;

my $clm_changelog = get_changelog();

# complain if either parameter is missing
($clm_name eq "") && die "Module name not specified\n";
($clm_version eq "") && die "Module version not specified\n";

# Create and Open file to create SPEC files.
mkdir($MainDir, 0755);
system('mkdir', '-p', '-m', '755', '/tmp/cpan/junk');
system('mkdir', '-p', '-m', '755', '/tmp/cpan/temp');
system('mkdir', '-p', '-m', '755', '/tmp/cpan/spec');
system("cp $InputFile $MainDir");
my $filename = 'Antenna';
open (FILE, "> $MainDir/$filename");

# Print the Antenna.
print FILE "Modified-Match: $clm_name";
print FILE '.*tar.gz.*(\d\d-\w\w\w-\d{4} \d\d:\d\d)';
print FILE "\n";
close(FILE);

my $filename = 'perl-' . $clm_name . '.spec';
open (FILE, "> $MainDir/$filename");

# Print the spec file. Lots of substitutions here.
print FILE "%define momorel $release
Summary: $clm_name module for perl $class
Name: perl-$clm_name
Version: $clm_version
Release: %{momorel}m
License: GPL
Group: Development/Languages
Source0: http://www.cpan.org/modules/by-module/$clm_base/$clm_name-%{version}.tar.gz
NoSource: 0
URL: http://www.cpan.org/modules/by-module/$clm_base/
BuildRoot: %{_tmppath}/%{name}-%{version}-root
BuildPreReq: perl >= $perlver

%description
$clm_name module for perl

%prep
%setup -q -n $clm_name-%{version} $create

%build
CFLAGS=\"%{optflags}\" perl Makefile.PL
make
make test

%clean 
rm -rf %{buildroot}

%install
rm -rf %{buildroot}
make install PERL_INSTALL_ROOT=%{buildroot}

find %{buildroot}/usr -type f -print | \\
	sed \"s\@^%{buildroot}\@\@g\" | \\
	grep -v perllocal.pod | \\
	sed -e 's,\\(.*/man/.*\\),\\1*,' | \\
	grep -v \"\\.packlist\" > $clm_name-%{version}-filelist
if [ \"\$(cat $clm_name-%{version}-filelist)X\" = \"X\" ] ; then
    echo \"ERROR: EMPTY FILE LIST\"
    exit -1
fi

%files -f $clm_name-%{version}-filelist
%defattr(-,root,root)
%doc Changes COPYING README* TODO

%changelog
* $clm_changelog
- ($clm_version-${release}m)
- spec file was autogenerated
";
close(FILE);

# Now build the rpm
create_rcfiles();

open (LOG, "> $MainDir/LogFile");
build_rpm();
close LOG;

sub cleanup {
  unlink "$MainDir/temp/perl-$clm_name-$clm_version-$release.nosrc.rpm";
  unlink "$MainDir/$tarball";
}

sub build_rpm {
  my $retval;

  # First, make sure it unpacks cleanely
  system("rpm --rcfile $MainDir/rpmrc -bp $MainDir/$filename");
  $retval = $? >> 8;
  if ($retval != 0) {
    print "RPM test unpacking failed!\n";
    print LOG "PREP failed: $filename\n";
    return;
  }

  system("mkdir -p $MainDir/spec/perl-$clm_name");
  system("cp $MainDir/$filename $MainDir/spec/perl-$clm_name");
  system("mv $MainDir/Antenna $MainDir/spec/perl-$clm_name");
  system("rpm --rcfile $MainDir/rpmrc -bs --rmsource --rmspec --clean $MainDir/$filename");
  $retval = $? >> 8;
  if ($retval != 0) {
    print "RPM building failed!\n";
    print LOG "SOURCE failed: $filename\n";
    return;
  }
  cleanup();
}

sub create_rcfiles {
    open(MACROS, "> $MainDir/macros");
    print MACROS qq{
%_topdir        $MainDir
%_builddir      %{_topdir}/junk
%_rpmdir        %{_topdir}
%_sourcedir     %{_topdir}
%_specdir       %{_topdir}
%_srcrpmdir     %{_topdir}/temp
};
    close(MACROS);
  
    open(RPMRC, "> $MainDir/rpmrc");
    print RPMRC qq{
include: /usr/lib/rpm/rpmrc
macrofiles: /usr/lib/rpm/macros:/usr/lib/rpm/%{_target}/macros:$MainDir/macros
};
    close(RPMRC);
}

sub get_changelog {
  # generate the changelog entry from available system info
	my ($name);

	$name = (getpwuid($<))[6];
	$name = (split(",", $name))[0];
  return ("Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat")[(localtime)[6]] . " " .
    ("Jan", "Feb", "Mar", "Apr", "May", "Jun",
     "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")[(localtime)[4]] . " " .
    (localtime)[3] . " " . (1900+(localtime)[5]) . " " .
		$name . " <" . $options{'email'} . ">";
}
